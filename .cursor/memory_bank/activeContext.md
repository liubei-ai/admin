# 活跃上下文

## 当前工作焦点

### 项目状态
- **阶段**: 功能完善和优化阶段
- **重点**: 基础功能已完成，正在优化用户体验和扩展功能
- **优先级**: 稳定性 > 新功能 > 性能优化

### 最近的重要变化

#### 已完成的功能
1. **认证系统** ✅
   - 登录/注册/邮件验证功能完成
   - httpOnly Cookie 认证系统实现
   - 用户状态管理实现
   - 路由守卫和权限控制

2. **主题系统** ✅
   - 明暗主题切换
   - 自定义主题色支持
   - 主题偏好持久化

3. **国际化** ✅
   - 中日英三语言支持
   - 动态语言切换
   - 翻译文件模块化管理

4. **AI功能集成** ✅
   - ChatGPT对话功能
   - 语音转文字服务
   - API密钥管理

5. **数据可视化** ✅
   - ApexCharts图表集成
   - ECharts图表支持
   - 仪表板数据展示

6. **任务管理** ✅
   - 拖拽式任务板
   - 任务状态管理
   - 任务分类功能


## 当前技术决策

### 最近的架构选择
1. **状态管理**: 选择Pinia替代Vuex
   - 更好的TypeScript支持
   - 简化的API设计
   - 更好的开发体验

2. **组件库**: 深度集成Vuetify 3
   - Material Design规范
   - 丰富的组件生态
   - 良好的响应式支持

3. **构建工具**: 使用Vite构建
   - 极快的开发体验
   - 现代化的插件生态
   - 优秀的TypeScript支持

### 重要的技术约束
- **浏览器支持**: 现代浏览器优先
- **性能要求**: 首屏加载 < 3秒
- **移动端适配**: 响应式设计必需
- **TypeScript**: 强制类型安全

## 开发模式和偏好

### 代码风格偏好
- **组合式API**: 优先使用`<script setup>`语法
- **类型安全**: 所有组件和函数都要有类型定义
- **模块化**: 功能按域划分，避免单一巨大文件
- **可测试性**: 业务逻辑与UI分离

### 组件设计原则
1. **单一职责**: 每个组件只负责一个功能
2. **可复用性**: 通用组件提取到公共目录
3. **配置驱动**: 通过props而非硬编码配置组件
4. **响应式**: 所有组件都要支持响应式设计

### 状态管理策略
- **局部状态优先**: 组件内部状态优先使用local state
- **全局状态最小化**: 只有跨组件共享的数据才放入store
- **持久化选择**: 重要的用户偏好数据持久化存储

## 当前挑战和解决方案

### 技术挑战
1. **性能优化**
   - **问题**: 大数据列表渲染性能
   - **解决方案**: 使用虚拟滚动组件
   - **状态**: 已实现，正在优化

2. **AI功能稳定性**
   - **问题**: OpenAI API调用稳定性
   - **解决方案**: 增加重试机制和错误处理
   - **状态**: 部分完成

3. **移动端适配**
   - **问题**: 复杂界面在小屏设备上的可用性
   - **解决方案**: 响应式设计和移动端优化
   - **状态**: 持续优化中

### 用户体验挑战
1. **加载性能**
   - **问题**: 首次加载时间较长
   - **解决方案**: 代码分割和懒加载
   - **状态**: 已实现部分优化

2. **国际化体验**
   - **问题**: 语言切换后部分内容未翻译
   - **解决方案**: 完善翻译文件，增加翻译检查
   - **状态**: 持续完善

## 即将进行的工作

### 短期计划（2-4周）
1. **完成密码重置功能**
   - 设计重置流程
   - 实现邮件发送
   - 测试安全性

2. **优化骨架屏组件**
   - 统一加载状态设计
   - 提供多种骨架屏样式
   - 文档和示例

3. **完善错误处理**
   - 全局错误边界
   - 用户友好的错误页面
   - 错误监控集成

### 中期计划（1-2个月）
1. **性能优化**
   - Bundle分析和优化
   - 图片资源优化
   - 缓存策略改进

2. **功能增强**
   - 更多AI功能集成
   - 数据导出功能
   - 高级搜索功能

3. **开发体验改进**
   - 完善测试覆盖
   - 改进开发文档
   - 增加代码示例

## 学习和洞察

### 技术洞察
1. **Vue 3生态**: 组合式API确实提供了更好的代码组织方式
2. **Vuetify 3**: 组件质量高，但需要深入了解才能充分利用
3. **TypeScript集成**: 类型安全带来的好处远超过学习成本

### 用户反馈洞察
1. **界面设计**: 用户更喜欢简洁的界面设计
2. **功能发现**: 需要更好的功能引导和帮助
3. **性能感知**: 加载状态和反馈对用户体验很重要

### 开发流程洞察
1. **代码组织**: 清晰的目录结构对团队协作很重要
2. **配置管理**: 环境变量和配置文件需要良好的管理
3. **测试策略**: 自动化测试对质量保证很重要

## 待决定的问题

### 技术选择
1. **是否引入微前端架构**
   - 考虑项目规模和复杂度
   - 评估团队技术能力
   - 权衡收益和成本

2. **是否增加PWA支持**
   - 评估用户需求
   - 考虑维护成本
   - 技术实现难度

### 功能规划
1. **是否增加实时通信功能**
   - WebSocket vs Server-Sent Events
   - 实时通知系统
   - 协作功能需求

2. **是否支持插件系统**
   - 插件架构设计
   - 第三方集成能力
   - 扩展性考虑

## 重要提醒

### 开发注意事项
- 所有新功能都需要考虑移动端适配
- 新增的第三方依赖需要评估安全性
- 重要功能变更需要向后兼容
- 性能关键路径需要特别关注

### 部署注意事项
- 环境变量配置完整性检查
- API密钥安全性验证
- 构建产物大小监控
- CDN缓存策略验证

## 最新技术方案 - 登录认证系统重构（2025-06-16）

### 背景与需求
- 服务端采用 httpOnly Cookie 存储登录态，提升安全性
- 前端无法直接访问 token，需要重新设计登录状态判断机制
- 登录表单需要从 email/password 改为 username/password
- 所有 API 响应需要统一为泛型结构，提升类型安全

### 核心技术决策

#### 1. API 响应结构标准化
```typescript
// src/types/api.ts
export interface ApiResponse<T = any> {
  code: number;
  message: string;
  data: T;
  timestamp: string;
}
```

#### 2. 登录状态管理策略
- **前端状态仅作缓存**：Pinia store 的 isLoggedIn 不能作为唯一判断依据
- **服务端验证为准**：通过 `/user/me` 接口校验真实登录状态
- **路由守卫机制**：优先检查缓存状态，必要时调用验证接口

#### 3. 认证流程设计
1. **登录流程**：
   - 调用 `/user/login` 接口（username + password）
   - 服务端设置 httpOnly Cookie
   - 前端调用 `/user/me` 获取用户信息
   - 更新 Pinia 状态并跳转

2. **状态校验**：
   - 页面刷新或路由跳转时检查 Pinia 状态
   - 如果状态为空或过期，调用 `/user/me` 验证
   - 根据验证结果更新状态或重定向登录页

3. **登出流程**：
   - 调用服务端登出接口清除 Cookie
   - 清空前端 Pinia 状态
   - 重定向到登录页

### 实现要点

#### 代码结构调整
- `src/api/authApi.ts`：封装认证相关 API 调用
- `src/stores/authStore.ts`：增加 `fetchCurrentUser` 方法
- `src/views/auth/SigninPage.vue`：表单字段改为 username/password
- `src/router/index.ts`：完善路由守卫逻辑
- `src/types/api.ts`：定义统一响应类型

#### 关键技术特性
- **类型安全**：全面使用 TypeScript 泛型约束
- **错误处理**：统一的 API 错误处理机制
- **状态同步**：支持多标签页登录状态同步
- **安全性**：token 不暴露在前端 JavaScript 中

### 方案优势
1. **安全性提升**：httpOnly Cookie 防止 XSS 攻击
2. **状态一致性**：服务端为准的状态判断机制
3. **开发体验**：统一的类型定义和错误处理
4. **扩展性**：便于后续添加二步验证等功能

### 后续计划
- 实现完整的认证 API 封装
- 完善路由守卫和错误处理
- 优化登录页面用户体验
- 添加登录状态过期提醒功能